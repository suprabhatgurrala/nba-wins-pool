name: Production Deploy
run-name: Deploy revision ${{ inputs.ref || 'main' }} by ${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      ref:
        description: The Git reference to deploy
        required: true
        type: string
        default: main
  push:
    branches:
      - main
jobs:
  Deploy-on-Self-hosted-Runner:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
            path: deploy
      - name: Create .env file for Discord token
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          NBA_API_KEY: ${{ secrets.NBA_API_KEY}}
        working-directory: deploy
        run: |
          echo "DISCORD_TOKEN=$DISCORD_TOKEN" > discord/.env
          echo "NBA_API_KEY=$NBA_API_KEY" >> backend/.env
      - name: Reload nbawinspool.service
        run: systemctl --user reload-or-restart nbawinspool.service
      - name: Check service status
        run: systemctl --user status nbawinspool.service
      - name: Post to Discord
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
